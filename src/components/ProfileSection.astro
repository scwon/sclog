---
/**
 * í”„ë¡œí•„ ì„¹ì…˜ ì»´í¬ë„ŒíŠ¸
 * í”„ë¡œí•„ ì‚¬ì§„, ì´ë¦„, í•œ ì¤„ ì†Œê°œ, ìê¸°ì†Œê°œë¥¼ í‘œì‹œ
 *
 * í”„ë¡œí•„ ì‚¬ì§„ hover/tap ì‹œ 3D ë™ì „ ë’¤ì§‘ê¸° ì• ë‹ˆë©”ì´ì…˜ìœ¼ë¡œ
 * ëŒ€ì²´ ì´ë¯¸ì§€(scwon_dot.png)ë¡œ ì „í™˜ë¨
 *
 * @component
 */
import type { Profile, SocialLink } from '../data/types';
import SocialLinks from './SocialLinks.astro';

interface Props {
  /** í”„ë¡œí•„ ë°ì´í„° */
  profile: Profile;
  /** ì†Œì…œ ë§í¬ ë°°ì—´ */
  socialLinks?: SocialLink[];
}

const { profile, socialLinks = [] } = Astro.props;
---

<section class="profile-section" aria-labelledby="profile-name">
  <div class="profile-avatar">
    <img class="avatar-default" src={profile.avatar} alt={`${profile.name} í”„ë¡œí•„ ì‚¬ì§„`} />
    <img class="avatar-alternate" src="/images/scwon_dot.png" alt="" aria-hidden="true" />
  </div>
  <h1 id="profile-name" class="profile-name">{profile.name}</h1>
  <p class="profile-tagline">{profile.tagline}</p>
  <p class="profile-bio">{profile.bio}</p>
  {socialLinks.length > 0 && (
    <SocialLinks links={socialLinks} email={profile.email} />
  )}
</section>

<style>
  .profile-section {
    text-align: center;
    padding: 3rem 0;
    border-bottom: 1px solid var(--color-border);
    margin-bottom: 3rem;
  }

  .profile-avatar {
    position: relative;
    width: 150px;
    height: 150px;
    margin: 0 auto 1.5rem;
    cursor: pointer;
    perspective: 1000px;
  }

  .avatar-default,
  .avatar-alternate {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    object-fit: cover;
    border-radius: 50%;
    backface-visibility: hidden;
    transition: transform 0.6s ease;
  }

  .avatar-alternate {
    transform: rotateY(180deg);
  }

  /* Hover íš¨ê³¼: 3D ë™ì „ ë’¤ì§‘ê¸° */
  .profile-avatar:hover .avatar-default,
  .profile-avatar.active .avatar-default {
    transform: rotateY(180deg);
  }

  .profile-avatar:hover .avatar-alternate,
  .profile-avatar.active .avatar-alternate {
    transform: rotateY(360deg);
  }

  .profile-name {
    font-size: 2rem;
    font-weight: 700;
    margin: 0 0 0.5rem;
    color: var(--color-text);
  }

  .profile-tagline {
    font-size: 1.1rem;
    color: var(--color-primary);
    margin: 0 0 1rem;
    font-weight: 500;
  }

  .profile-bio {
    color: var(--color-text-muted);
    font-size: 1rem;
    line-height: 1.6;
    max-width: 600px;
    margin: 0 auto 1.5rem;
  }

  @media (max-width: 640px) {
    .profile-section {
      padding: 2rem 0;
    }

    .profile-avatar {
      width: 120px;
      height: 120px;
    }

    .profile-name {
      font-size: 1.5rem;
    }

    .profile-tagline {
      font-size: 1rem;
    }

    .profile-bio {
      font-size: 0.9rem;
    }
  }

  /* ìŠ¤í•€ ì• ë‹ˆë©”ì´ì…˜ ì¤‘ CSS transition ë¹„í™œì„±í™” */
  .profile-avatar.spinning .avatar-default,
  .profile-avatar.spinning .avatar-alternate {
    transition: none !important;
  }

  /* ì ‘ê·¼ì„±: ë™ì‘ ê°ì†Œ ì„¤ì • ì¡´ì¤‘ */
  @media (prefers-reduced-motion: reduce) {
    .avatar-default,
    .avatar-alternate {
      transition: opacity 0.1s ease;
      backface-visibility: visible;
    }

    .avatar-alternate {
      transform: none;
      opacity: 0;
    }

    .profile-avatar:hover .avatar-default,
    .profile-avatar.active .avatar-default {
      transform: none;
      opacity: 0;
    }

    .profile-avatar:hover .avatar-alternate,
    .profile-avatar.active .avatar-alternate {
      transform: none;
      opacity: 1;
    }
  }
</style>

<script>
  /**
   * í”„ë¡œí•„ ìŠ¤í•€ ì• ë‹ˆë©”ì´ì…˜ ìƒìˆ˜
   * @description ë§ˆìš°ìŠ¤ ì†ë„ ì„ê³„ê°’ê³¼ ë¬¼ë¦¬ ì‹œë®¬ë ˆì´ì…˜ íŒŒë¼ë¯¸í„°
   */
  const VELOCITY_THRESHOLD = 500; // ìŠ¤í•€ íŠ¸ë¦¬ê±° ìµœì†Œ ì†ë„ (px/s)
  const FRICTION = 0.96; // ê°ì† ê³„ìˆ˜ (ë‚®ì„ìˆ˜ë¡ ë¹¨ë¦¬ ë©ˆì¶¤)
  const MIN_ANGULAR_VELOCITY = 0.5; // ì •ì§€ íŒì • ì„ê³„ê°’ (deg/frame)
  const VELOCITY_TO_ANGULAR = 0.008; // ë§ˆìš°ìŠ¤ ì†ë„ â†’ ê°ì†ë„ ë³€í™˜ ê³„ìˆ˜ (ë‚®ì¶œìˆ˜ë¡ ëŠë¦¬ê²Œ íšŒì „)

  /**
   * í”„ë¡œí•„ ì‚¬ì§„ ì¸í„°ë™ì…˜ ì´ˆê¸°í™”
   * - í„°ì¹˜ ê¸°ê¸°: íƒ­ìœ¼ë¡œ hover íš¨ê³¼ ëŒ€ì²´
   * - ë§ˆìš°ìŠ¤: ë¹ ë¥¸ íŒ¨ìŠ¤ë¡œ ìŠ¤í•€ ì• ë‹ˆë©”ì´ì…˜ íŠ¸ë¦¬ê±°
   */
  function initProfileInteraction() {
    const avatarEl = document.querySelector('.profile-avatar') as HTMLElement | null;
    const defaultEl = document.querySelector('.avatar-default') as HTMLElement | null;
    const alternateEl = document.querySelector('.avatar-alternate') as HTMLElement | null;

    if (!avatarEl || !defaultEl || !alternateEl) return;

    // Non-null ë³´ì¥ëœ ì°¸ì¡°
    const avatar = avatarEl;
    const avatarDefault = defaultEl;
    const avatarAlternate = alternateEl;

    // ì ‘ê·¼ì„±: ë™ì‘ ê°ì†Œ ì„¤ì • í™•ì¸
    const prefersReducedMotion = window.matchMedia('(prefers-reduced-motion: reduce)').matches;

    // ë§ˆìš°ìŠ¤ ì†ë„ ì¸¡ì • ìƒíƒœ
    let lastX = 0;
    let lastY = 0;
    let lastTime = 0;

    // ìŠ¤í•€ ì• ë‹ˆë©”ì´ì…˜ ìƒíƒœ
    let rotation = 0;
    let angularVelocity = 0;
    let isSpinning = false;
    let animationId: number | null = null;

    /**
     * ë§ˆìš°ìŠ¤ ì´ë™ ì†ë„ ê³„ì‚°
     * @param e - ë§ˆìš°ìŠ¤ ì´ë²¤íŠ¸
     * @returns ì†ë„ (px/s)
     */
    function calculateVelocity(e: MouseEvent): number {
      const now = performance.now();
      const dt = now - lastTime;

      if (dt === 0 || lastTime === 0) {
        lastX = e.clientX;
        lastY = e.clientY;
        lastTime = now;
        return 0;
      }

      const dx = e.clientX - lastX;
      const dy = e.clientY - lastY;
      const distance = Math.sqrt(dx * dx + dy * dy);
      const velocity = (distance / dt) * 1000; // px/s

      lastX = e.clientX;
      lastY = e.clientY;
      lastTime = now;

      return velocity;
    }

    /**
     * ìŠ¤í•€ ì• ë‹ˆë©”ì´ì…˜ ì‹œì‘
     * @param mouseVelocity - ë§ˆìš°ìŠ¤ ì†ë„ (px/s)
     */
    function startSpin(mouseVelocity: number): void {
      // ë§ˆìš°ìŠ¤ ì†ë„ë¥¼ ê°ì†ë„ë¡œ ë³€í™˜
      const newAngularVelocity = mouseVelocity * VELOCITY_TO_ANGULAR;

      if (isSpinning) {
        // ì´ë¯¸ ìŠ¤í•€ ì¤‘ì´ë©´ ì¶”ê°€ íšŒì „ë ¥ ë¶€ì—¬
        angularVelocity += newAngularVelocity;
      } else {
        angularVelocity = newAngularVelocity;
        isSpinning = true;
        avatar.classList.add('spinning');
        animate();
      }
    }

    /**
     * ìŠ¤í•€ ì• ë‹ˆë©”ì´ì…˜ ë£¨í”„ (requestAnimationFrame)
     * @description ì§€ìˆ˜ ê°ì‡  ëª¨ë¸ë¡œ ìì—°ìŠ¤ëŸ¬ìš´ ê°ì† êµ¬í˜„
     */
    function animate(): void {
      if (Math.abs(angularVelocity) < MIN_ANGULAR_VELOCITY) {
        stopSpin();
        return;
      }

      rotation += angularVelocity;
      angularVelocity *= FRICTION; // ë§ˆì°°ì— ì˜í•œ ê°ì†

      // ì–‘ë©´ ëª¨ë‘ ë™ì¼í•˜ê²Œ íšŒì „
      avatarDefault.style.transform = `rotateY(${rotation}deg)`;
      avatarAlternate.style.transform = `rotateY(${rotation + 180}deg)`;

      animationId = requestAnimationFrame(animate);
    }

    /**
     * ìŠ¤í•€ ì• ë‹ˆë©”ì´ì…˜ ì •ì§€
     * @description í˜„ì¬ ìœ„ì¹˜ì—ì„œ ê·¸ëŒ€ë¡œ ë©ˆì¶¤
     */
    function stopSpin(): void {
      isSpinning = false;
      angularVelocity = 0;

      if (animationId) {
        cancelAnimationFrame(animationId);
        animationId = null;
      }

      // í˜„ì¬ íšŒì „ ê°ë„ë¥¼ 0~360 ë²”ìœ„ë¡œ ì •ê·œí™”
      rotation = ((rotation % 360) + 360) % 360;

      // spinning í´ë˜ìŠ¤ ì œê±° (CSS transition ë³µì›)
      avatar.classList.remove('spinning');

      // í˜„ì¬ ìœ„ì¹˜ ê·¸ëŒ€ë¡œ ìœ ì§€ (inline style ìœ ì§€)
      // hover ì‹œ CSSê°€ ë‹¤ì‹œ ì‘ë™í•˜ë„ë¡ ë‚˜ì¤‘ì— ì •ë¦¬
    }

    // ë¬¸ì„œ ì „ì²´ì—ì„œ ë§ˆìš°ìŠ¤ ìœ„ì¹˜ ì¶”ì  (í”„ë¡œí•„ ì§„ì… ì „ ì†ë„ ì¸¡ì •)
    document.addEventListener('mousemove', (e) => {
      calculateVelocity(e);
    });

    // ë§ˆìš°ìŠ¤ê°€ í”„ë¡œí•„ ì˜ì—­ì— ì§„ì…í•  ë•Œ ì†ë„ ì²´í¬
    avatar.addEventListener('mouseenter', (e) => {
      if (prefersReducedMotion) return;

      const velocity = calculateVelocity(e);

      if (velocity > VELOCITY_THRESHOLD && !isSpinning) {
        startSpin(velocity);
      }
    });

    // í´ë¦­ìœ¼ë¡œ ìŠ¤í•€ ì •ì§€ (ë¹ ë¥¸ ê°ì†)
    avatar.addEventListener('click', () => {
      if (isSpinning) {
        angularVelocity *= 0.3; // ê¸‰ì •ì§€ ëŒ€ì‹  ë¹ ë¥¸ ê°ì†
      }
    });

    // í„°ì¹˜ ê¸°ê¸° ëŒ€ì‘: ìŠ¤ì™€ì´í”„ë¡œ ìŠ¤í•€ íŠ¸ë¦¬ê±°
    let touchStartX = 0;
    let touchStartTime = 0;

    avatar.addEventListener('touchstart', (e) => {
      if (prefersReducedMotion) {
        // ë™ì‘ ê°ì†Œ ëª¨ë“œì—ì„œëŠ” ê¸°ì¡´ íƒ­ ë™ì‘ë§Œ
        e.preventDefault();
        avatar.classList.toggle('active');
        return;
      }

      touchStartX = e.touches[0].clientX;
      touchStartTime = performance.now();
    });

    avatar.addEventListener('touchend', (e) => {
      if (prefersReducedMotion) return;

      const dx = e.changedTouches[0].clientX - touchStartX;
      const dt = performance.now() - touchStartTime;

      // ì§§ì€ íƒ­ì€ ê¸°ì¡´ ë™ì‘ (active í† ê¸€)
      if (dt < 200 && Math.abs(dx) < 20) {
        if (isSpinning) {
          angularVelocity *= 0.3; // íƒ­ìœ¼ë¡œ ê°ì†
        } else {
          avatar.classList.toggle('active');
        }
        return;
      }

      // ìŠ¤ì™€ì´í”„ë¡œ ìŠ¤í•€ íŠ¸ë¦¬ê±°
      const velocity = Math.abs(dx / dt) * 1000;
      if (velocity > VELOCITY_THRESHOLD) {
        e.preventDefault();
        startSpin(velocity);
      }
    });

    // ë‹¤ë¥¸ ê³³ íƒ­ ì‹œ ìƒíƒœ í•´ì œ
    document.addEventListener('touchstart', (e) => {
      if (!avatar.contains(e.target as Node)) {
        avatar.classList.remove('active');
      }
    });

    // View Transition ì‹œ ì• ë‹ˆë©”ì´ì…˜ cleanup
    document.addEventListener('astro:before-swap', () => {
      if (isSpinning) {
        stopSpin();
      }
    });
  }

  // ì´ˆê¸°í™”: DOMContentLoaded ë˜ëŠ” ì¦‰ì‹œ ì‹¤í–‰
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initProfileInteraction);
  } else {
    initProfileInteraction();
  }

  // Astro View Transitions ëŒ€ì‘ (í˜ì´ì§€ ì „í™˜ ì‹œ ì¬ì´ˆê¸°í™”)
  document.addEventListener('astro:page-load', initProfileInteraction);

  console.log('ğŸ”§ ProfileSection script loaded');
</script>
